# Cloudflare Keepalive Worker

一个基于 **Cloudflare Workers Scheduled Trigger** 的轻量级保活与自愈触发组件。

该项目用于**定期探测一组服务 URL 的可用性**，当目标服务在多次重试后仍不可用时，**自动触发下游部署接口**（如 GitHub 文件更新、重新部署等），以维持关联项目的活跃状态。

---

## 核心能力

- 定时执行（Cloudflare Scheduled Trigger）
- 批量 URL 可用性探测
- 请求超时与指数退避重试
- 基于 URL 特征的失败触发机制
- 通过 Token 鉴权调用外部部署接口
- 与具体部署实现解耦（仅负责触发）

---

## 设计目标

- **低成本保活**：适用于免费 / Serverless / 冷启动敏感服务  
- **最小侵入**：不依赖服务本身埋点或改造  
- **强约束触发**：避免误触发、风暴式调用  
- **职责单一**：仅负责“探测 + 触发”，不关心部署细节  

---

## 工作流程

```text
定时任务触发
     │
     ▼
解析 URL_LIST
     │
     ▼
并发探测所有 URL
     │
     ├─ 请求成功 → 忽略
     │
     └─ 请求失败
         ├─ 4xx → 直接失败
         └─ 5xx → 重试（指数退避）
                 └─ 最终失败
                     └─ URL 命中关键字
                         └─ 调用部署接口
````

---

## 触发条件说明

只有在满足 **全部条件** 时，才会调用部署接口：

1. 请求最终失败（已完成所有重试）
2. URL 中包含指定关键字（如 `galaxy`）
3. 部署接口返回成功或失败均不会影响本次定时任务完成

---

## 环境变量配置

### 必需变量

| 变量名              | 说明                           |
| ---------------- | ---------------------------- |
| `URL_LIST`       | 需要探测的 URL 列表（每行一个，支持 `#` 注释） |
| `DEPLOY_API_URL` | 部署触发接口地址                     |
| `FIXED_TOKEN`    | 调用部署接口使用的固定 Token            |

### `URL_LIST` 示例

```text
# 主服务
https://example.com/health

# 需要重点保活的服务
https://xxx.galaxycloud.app/status
```

---

## 重试策略

* 单次请求超时：5 秒
* 最大重试次数：3 次
* 重试方式：指数退避（Exponential Backoff）

该策略用于避免：

* 短暂网络抖动导致误触发
* 对下游服务造成请求洪峰

---

## 安全设计

* 部署接口通过 Header Token 鉴权
* Token 不暴露在 URL 或日志中
* Worker 本身不保存任何凭据状态
* 可与下游服务的 KV / 幂等机制配合使用

---

## 适用场景

* Serverless 项目防休眠
* 免费托管服务保活
* 关键依赖服务异常时的自动恢复触发
* GitHub 仓库自动更新时间戳、触发部署等

---

## 技术栈

* Cloudflare Workers（Module Worker）
* Scheduled Trigger
* Fetch API / AbortController

---

## 项目定位说明

本项目 **不是监控系统**，也不是部署系统：

* 不提供告警
* 不做状态存储
* 不参与具体部署逻辑

它只负责一件事：

> **当“该醒的服务没有醒”时，敲一下该醒它的门。**

---

## License

MIT
